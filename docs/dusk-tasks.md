# Dusk Test Tasks

Plan and checklist for introducing Laravel Dusk browser tests. This extends the current Filament test coverage with full end-to-end (E2E) flows through the UI and command dispatch.

Last updated: 2025-10-06 20:17

Conventions

- Keep Dusk scenarios lean; prefer stubbing network I/O and seeding minimal data.
- Prefer headless Chrome for local runs; use Laravel Herd’s bundled Chrome/Chromedriver when possible.
- Use the Testing database; reset state per test with RefreshDatabase or DatabaseMigrations when appropriate.
- Avoid flakiness: wait for visible UI state (assertSee/whenAvailable) rather than fixed sleeps.
- Follow `/.junie/guidelines.md` and run `composer all` before marking a task complete.

---

## Setup: Laravel Dusk

Goal: Install and configure Laravel Dusk for local development and CI.

Tasks and Acceptance Criteria:
- [ ] Require Dusk in dev only
  - `composer require --dev laravel/dusk`
  - Commit the default scaffolding generated by `php artisan dusk:install` (DuskTestCase, Browser/.env, tests/Browser, etc.).
- [ ] Configure environment
  - Add `APP_URL` matching local domain (e.g., https://solar.test) in `.env.dusk.local`.
  - Ensure the test database is configured for Dusk (separate sqlite or dedicated DB). Consider `DB_CONNECTION=sqlite` and a temporary sqlite file.
- [ ] Chrome/Chromedriver
  - Prefer Herd-managed Chrome; ensure Chromedriver compatibility. If needed, set `DUSK_DRIVER_URL` or pin driver via `php artisan dusk:chrome-driver`.
  - Headless by default: set `--headless=new` in Dusk options.
- [ ] CI setup (optional in this phase)
  - Document GitHub Actions matrix using `shivammathur/setup-php` and installing Chrome.
  - Cache Composer dependencies; run `php artisan dusk` headless.
- [ ] Data and auth helpers
  - Seed a default test user (Email: test@example.com, Password: password) via seeder or factory.
  - Provide helper methods for logging in to Filament admin before visiting pages.

## Running Dusk

- Local, headless (preferred): `php artisan dusk`.
- Local, visible browser: set `DUSK_HEADFUL=1` or temporarily remove `--headless` options in DuskTestCase.
- Single test file: `php artisan dusk tests/Browser/StrategyGenerationTest.php`.
- Filter by class/method: `php artisan dusk --filter=StrategyGenerationTest`.
- Screenshots/logs: on failure, check `tests/Browser/screenshots` and `tests/Browser/console`.

## Target E2E Flow: Strategy generation end-to-end

Goal: Validate that a Strategy can be generated end-to-end, from initiating the generation (via Filament UI action) which dispatches the command, to verifying the Strategy persisted with correct Value Object (VO) states.

Scope and acceptance criteria:
- [ ] Seed or factory-create minimal prerequisites (e.g., user, any required rates/forecasts if the command expects them). Prefer fakes for external APIs.
- [ ] Sign in to Filament as the seeded test user.
- [ ] Navigate to StrategyResource list page.
- [ ] Trigger the "Generate Strategy" action that dispatches the command via the CommandBus.
- [ ] Wait for success notification and redirect/back to list.
- [ ] Assert a Strategy record exists in the database with expected VO fields:
  - StrategyType mapped correctly for strategy1/strategy2/strategy_manual
  - CostData contains coherent totals
  - ConsumptionData populated for required intervals
  - BatteryState reflects expected state-of-charge changes
- [ ] Optionally open the Strategy show/edit page and assert key VO-derived values render.

Implementation notes:
- Consider binding fake implementations of external Queries/Actions in the service container within the Dusk test’s `setUp` (via routes or a TestServiceProvider limited to `APP_ENV=dusk`).
- Keep test time deterministic using `Carbon::setTestNow()` to avoid date-sensitive flakiness.
- If long-running background jobs are involved, configure `QUEUE_CONNECTION=sync` for Dusk.

## Additional scenarios to queue (after initial E2E)

- [ ] Forecast import via UI action leads to new Forecast rows and charts update at next load.
- [ ] Octopus Agile import and cost charts render expected labels and sums.
- [ ] Inverter data upload flow (if upload UI exists) validates file and persists readings.
- [ ] Filament access control: unauthenticated users get redirected; standard user vs admin capabilities.

## Done Definition for this stage

- [ ] Dusk installed, configured, and basic smoke test passing locally.
- [ ] README and .junie/guidelines.md include clear instructions for installing and running Dusk.
- [ ] First E2E test for Strategy generation implemented and green locally.
- [ ] composer all passes (coding standards, static analysis, and tests acceptable).
